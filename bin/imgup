#!/usr/bin/env ruby

# Load environment variables from project and user scope
require 'dotenv'
Dotenv.load('.env', File.expand_path('~/.imgup.env'))

require 'optparse'
require_relative '../lib/imgup/uploader'

options = {}
parser = OptionParser.new do |opts|
  opts.banner = "Usage: imgup [options] <path/to/image>"

  opts.on("-tTITLE", "--title=TITLE", "Image title (default: filename)") do |t|
    options[:title] = t
  end

  opts.on("-cCAPTION", "--caption=CAPTION", "Image caption (optional)") do |c|
    options[:caption] = c
  end

  opts.on("-h", "--help", "Show this help message") do
    puts opts
    exit
  end
end

# Remove parsed options from ARGV, leaving only the image path
begin
  parser.parse!
rescue OptionParser::InvalidOption => e
  $stderr.puts e.message
  $stderr.puts parser
  exit 1
end

# Ensure exactly one positional argument (the file path)
if ARGV.length != 1
  $stderr.puts parser
  exit 1
end

file = ARGV.first
unless File.file?(file)
  $stderr.puts "File not found: #{file}"
  exit 1
end

# Perform upload and output Markdown snippet
begin
  result = ImgUp::Uploader.new(
    file,
    title:   options[:title],
    caption: options[:caption]
  ).call
  puts result[:org]
rescue => e
  $stderr.puts e.message
  exit 1
end
